---
title: "Deepflow"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, include=FALSE}
library(kerasR)
library(largeVis)
library(DT)
library(DBI)
library(RSQLite)
library(deepflow)
library(ggplot2)

sqlitePath <- "~/.deepflow/deepflow.db"
gates = vector()

# Retrieve table names
db <- dbConnect(RSQLite::SQLite(), sqlitePath)

parameters <- reactiveValues(data=NULL, selection=NULL, coordinates=NULL)


filenames <- dbListTables(db)
files <-  data.frame(File=filenames) 
dbDisconnect(db)
```

Visualisations
=======================================================================


Column {data-width=250}
-----------------------------------------------------------------------
### My Files
```{r}
DT::dataTableOutput("filelist")
output$filelist <- DT::renderDataTable({
	DT::datatable(files, options = list(bPaginate = FALSE), selection="single")
}, server=FALSE, selection="single")

observeEvent(input$filelist_rows_selected,
	     {ix <- input$filelist_rows_selected
	     fcs <- pull_fcs(filenames[ix], sqlitePath)
	     gates <- colnames(fcs)
	     parameters$data <- fcs
	     parameters$selection <- colnames(fcs)

	     db <- dbConnect(RSQLite::SQLite(), sqlitePath)
	     exists <- dbExistsTable(db, paste0(filenames[ix], "_coordinates"))
	     if(exists){
		     parameters$coordinates <- dbReadTable(db, paste0(filenames[ix], "_coordinates"))
		     parameters$selection <- dbReadTable(db, paste0(filenames[ix], "_gates"))[,1]
		     updateSelectizeInput(session, 'visualiseGates', choices=parameters$selection)
	     }
	     dbDisconnect(db)
 
	     updateSelectizeInput(session, 'gateSelect', choices=gates)})
			

```

### Run
```{r}


selectInput("gateSelect", "Select Gates", gates, multiple=TRUE, selectize=FALSE, width="100%", size=8)

checkboxInput("asinhTransform", label = "Apply hyperbolic arcsin transformation", value = TRUE)

actionButton("run", "Analyse", width = "100%")
```

Column {data-width=500}
-----------------------------------------------------------------------
### Representative Features

```{r}
autoencode <- eventReactive(input$run, {
		withProgress(message = 'Learning...this may take a while', value = 0, max=4, {
		ix <- input$filelist_rows_selected
		fcs <- parameters$data
		parameters$selection <- input$gateSelect
		

		X <- data.matrix(data.matrix(asinh(fcs[, parameters$selection]/5)))
		incProgress(1, detail = "Running autoencoder.")	
		a <- autoencoder(X)
		yh <- as.data.frame(keras_predict(a$encoder, X))
		tX <- t(yh)

		incProgress(1, detail = "Estimating embeddings.")		
		v <- largeVis(tX, threads=4, verbose=TRUE)
		xy <- t(v$coords)
		coordinates <- data.frame(Deep1=xy[,1], Deep2=xy[,2])
		parameters$coordinates <- coordinates
		
		incProgress(1, detail = "Saving results to database.")
		db <- dbConnect(RSQLite::SQLite(), sqlitePath)
		dbWriteTable(db, paste0(filenames[input$filelist_rows_selected], "_coordinates"), coordinates, overwrite=TRUE)
		dbWriteTable(db, paste0(filenames[input$filelist_rows_selected], "_gates"), data.frame(Gates = parameters$selection), overwrite=TRUE)	

		dbDisconnect(db)
		})

		coordinates
		
})

renderPlot({
	if (is.null(parameters$data) | is.null(parameters$selection)){
		return()
	}else if (is.null(parameters$coordinates)){
		p <- ggplot(autoencode(), aes(Deep1, Deep2)) + geom_point()
		print(p)
	}else {
		ggplot(parameters$coordinates, aes(Deep1, Deep2)) + geom_point()
	}
})

```

Column {data-width=250}
-----------------------------------------------------------------------
### Gates
```{r}
selectInput("visualiseGates", "Visualise Gates", gates, multiple=TRUE, selectize=FALSE, width="100%", size=8)

observeEvent(input$run, {
		      updateSelectizeInput(session, 'visualiseGates', choices=parameters$selection)
})

actionLink("clearOutput", "x Clear All Output")

observeEvent(input$clearOutput, {
	parameters <- reactiveValues(data=NULL, selection=NULL, coordinates=NULL)
	db <- dbConnect(RSQLite::SQLite(), sqlitePath)
	ix <- input$filelist_rows_selected
	dbRemoveTable(db, paste0(filenames[ix], "_coordinates"))
	dbRemoveTable(db, paste0(filenames[ix], "_gates"))
	dbDisconnect(db)

})

```

### Actions

```{r}

actionLink("saveImage", "âŽ™ Save Image")

```


Help
=======================================================================



